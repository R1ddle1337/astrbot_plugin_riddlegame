# AstrBot 小游戏合集插件

基于 AstrBot 的 QQ 群小游戏合集插件，支持井字棋、围棋、中国象棋和五子棋。游戏状态以精美图片形式展示。

## 功能特性

- 井字棋：经典两人对战
- 围棋：支持 9x9、13x13、19x19 三种棋盘
- 象棋：完整规则的中国象棋
- 五子棋：支持 13x13、15x15、19x19 三种棋盘
- 图片渲染：精美的游戏界面
- 超时机制：每回合限时，超时自动认输
- 等待超时：无人加入时自动取消游戏并撤回消息
- 消息撤回：新棋盘图片发送时自动撤回上一张（保持聊天整洁）

---

## 井字棋

两人对战的经典井字棋游戏，在群聊中使用。

### 命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `/井字棋` | `ttt`, `tictactoe`, `开始井字棋` | 发起一局井字棋 |
| `/加入井字棋` | `jointtt`, `加入游戏`, `join` | 加入对局 |
| `/下棋 <位置>` | `move`, `m` | 落子，位置为 1-9 |
| `/棋盘` | `board`, `查看棋盘` | 查看当前棋盘 |
| `/认输` | `surrender`, `投降` | 认输 |
| `/结束游戏` | `endgame`, `结束井字棋` | 强制结束当前游戏 |

### 棋盘位置

数字 1-9 对应棋盘的九个格子：

```
┌───┬───┬───┐
│ 1 │ 2 │ 3 │
├───┼───┼───┤
│ 4 │ 5 │ 6 │
├───┼───┼───┤
│ 7 │ 8 │ 9 │
└───┴───┴───┘
```

### 游戏流程

```
玩家A: /井字棋       ← 发起游戏（A 为 X 方先手）
玩家B: /加入井字棋   ← 加入游戏（B 为 O 方后手）
玩家A: /下棋 5       ← X 方落子到中间
玩家B: /下棋 1       ← O 方落子到左上角
...                   ← 交替落子直到分出胜负或平局
```

### 规则

- 每个群同时只能有一局游戏
- X 方先手，O 方后手，交替落子
- 率先在横/竖/对角线连成三子的一方获胜
- 棋盘填满且无人获胜则为平局
- 可以随时认输或强制结束游戏

---

## 围棋

支持多种棋盘大小的围棋游戏，包含完整规则（提子、超级劫、悔棋、计分）。

### 命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `/围棋 [大小]` | `go`, `weiqi` | 发起围棋，大小可选 9/13/19，默认 9 |
| `/加入围棋` | `joingo` | 加入对局（白方） |
| `/落子 <坐标>` | `play`, `p` | 落子，如 `/落子 D4` 或 `/落子 4,4` |
| `/虚着` | `pass`, `跳过` | 放弃本回合落子 |
| `/悔棋` | `undo`, `撤回` | 撤回上一步（仅限刚落子的玩家） |
| `/点目` | `score`, `形势` | 查看当前形势判断 |
| `/请求计分` | `requestscore`, `申请计分` | 请求结束游戏并计分 |
| `/同意计分` | - | 同意对方的计分请求 |
| `/拒绝计分` | `rejectscore`, `继续游戏` | 拒绝计分请求 |
| `/棋盘` | `board`, `查看棋盘` | 查看当前棋盘 |
| `/认输` | `surrender`, `投降` | 认输 |
| `/结束游戏` | `endgame`, `结束围棋` | 强制结束 |

### 坐标系统

采用标准围棋坐标（列字母跳过 I 避免与 1 混淆）：

```
  A B C D E F G H J
9 · · · · · · · · · 9
8 · · · · · · · · · 8
7 · · · · · · · · · 7
6 · · · · · · · · · 6
5 · · · · ● · · · · 5    ← D5 为黑棋
4 · · · ○ · · · · · 4    ← D4 为白棋
3 · · · · · · · · · 3
2 · · · · · · · · · 2
1 · · · · · · · · · 1
  A B C D E F G H J
```

支持的坐标格式：
- 字母+数字：`D4`, `d4`
- 数字,数字：`4,4`, `4-4`

### 游戏流程

```
玩家A: /围棋 9       ← 发起 9x9 游戏（A 为黑方先手）
玩家B: /加入围棋     ← 加入游戏（B 为白方后手）
玩家A: /落子 E5      ← 黑方落子
玩家B: /落子 D4      ← 白方落子
玩家B: /悔棋         ← 白方悔棋（撤回 D4）
玩家B: /落子 C3      ← 白方重新落子
...                   ← 交替落子
玩家A: /点目         ← 查看当前形势
玩家A: /请求计分     ← 黑方请求计分
玩家B: /同意计分     ← 白方同意，游戏结束并计分
```

也可以通过双方连续虚着结束：

```
玩家A: /虚着         ← 黑方 PASS
玩家B: /虚着         ← 白方 PASS，双方连续虚着游戏结束
```

### 规则

- 黑方先手，白方后手
- 棋子被完全包围（无气）时被提走
- 禁止自杀（落子后自己无气且不能提对方子）
- 超级劫规则：禁止全局同型重复
- 悔棋：只有刚落子的玩家可以悔棋，每步只能悔一次
- 双方连续虚着（PASS）时游戏结束
- 计分采用中国规则：子+地+贴目（白方贴 6.5 目）
- 可以随时认输，或双方同意计分结束游戏

---

## 中国象棋

完整规则的中国象棋游戏，支持将军检测和将死判定。

### 命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `/象棋` | `xiangqi`, `中国象棋` | 发起一局象棋 |
| `/加入象棋` | `joinxiangqi` | 加入对局（黑方） |
| `/走棋 <起点>-<终点>` | `xmove`, `xm` | 走棋，如 `/走棋 E1-E2` |
| `/棋盘` | `board`, `查看棋盘` | 查看当前棋盘 |
| `/认输` | `surrender`, `投降` | 认输 |
| `/结束游戏` | `endgame`, `结束象棋` | 强制结束 |

### 坐标系统

```
   A   B   C   D   E   F   G   H   I
10 車--馬--象--士--将--士--象--馬--車  黑方
 9 ·   ·   ·   ·   ·   ·   ·   ·   ·
 8 ·  砲   ·   ·   ·   ·   ·  砲   ·
 7 卒--·--卒--·--卒--·--卒--·--卒
 6 ·   ·   ·   ·   ·   ·   ·   ·   ·
   =========楚河  汉界=========
 5 ·   ·   ·   ·   ·   ·   ·   ·   ·
 4 兵--·--兵--·--兵--·--兵--·--兵
 3 ·  炮   ·   ·   ·   ·   ·  炮   ·
 2 ·   ·   ·   ·   ·   ·   ·   ·   ·
 1 车--马--相--仕--帅--仕--相--马--车  红方
   A   B   C   D   E   F   G   H   I
```

支持的坐标格式：
- 字母+数字：`E1-E2`, `e1-e2`
- 数字,数字：`5,1-5,2`

### 游戏流程

```
玩家A: /象棋         ← 发起游戏（A 为红方先手）
玩家B: /加入象棋     ← 加入游戏（B 为黑方后手）
玩家A: /走棋 E1-E2   ← 红方走棋
玩家B: /走棋 E10-E9  ← 黑方走棋
...                   ← 交替走棋直到将死或认输
```

### 规则

- 红方先手，黑方后手
- 帅/将：九宫内一步直行
- 仕/士：九宫内斜走一步
- 相/象：田字斜走，不能过河，塞象眼
- 马：日字走，蹩马腿
- 车：直线走
- 炮：直线走，隔子吃（翻山）
- 兵/卒：未过河直进，过河可横走
- 将帅不能对脸
- 将军时必须应将
- 将死或困毙则游戏结束

---

## 五子棋

经典的五子棋游戏，支持多种棋盘大小。

### 命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `/五子棋 [大小]` | `gomoku`, `wuziqi` | 发起五子棋，大小可选 13/15/19，默认 15 |
| `/加入五子棋` | `joingomoku` | 加入对局（白方） |
| `/五子 <坐标>` | `gmove`, `gm` | 落子，如 `/五子 H8` 或 `/五子 8,8` |
| `/棋盘` | `board`, `查看棋盘` | 查看当前棋盘 |
| `/认输` | `surrender`, `投降` | 认输 |
| `/结束游戏` | `endgame`, `结束五子棋` | 强制结束 |

### 坐标系统

采用标准五子棋坐标（列字母跳过 I 避免与 1 混淆）：

```
   A B C D E F G H J K L M N O
15 · · · · · · · · · · · · · · 15
14 · · · · · · · · · · · · · · 14
13 · · · · · · · · · · · · · · 13
12 · · · · · · · · · · · · · · 12
11 · · · · · · · · · · · · · · 11
10 · · · · · · · · · · · · · · 10
 9 · · · · · · · · · · · · · ·  9
 8 · · · · · · · ● · · · · · ·  8  ← H8 为黑棋
 7 · · · · · · · · · · · · · ·  7
 6 · · · · · · · · · · · · · ·  6
 5 · · · · · · · · · · · · · ·  5
 4 · · · · · · · · · · · · · ·  4
 3 · · · · · · · · · · · · · ·  3
 2 · · · · · · · · · · · · · ·  2
 1 · · · · · · · · · · · · · ·  1
   A B C D E F G H J K L M N O
```

支持的坐标格式：
- 字母+数字：`H8`, `h8`
- 数字,数字：`8,8`, `8-8`

### 游戏流程

```
玩家A: /五子棋       ← 发起 15x15 游戏（A 为黑方先手）
玩家B: /加入五子棋   ← 加入游戏（B 为白方后手）
玩家A: /五子 H8      ← 黑方落子
玩家B: /五子 H7      ← 白方落子
...                   ← 交替落子直到五子连珠或棋盘填满
```

### 规则

- 黑方先手，白方后手
- 在横、竖、斜任意方向连成五子（或更多）即获胜
- 棋盘填满且无人获胜则为平局
- 可以随时认输

---

## 军棋（翻棋模式）

军棋翻棋模式，两人对战，随机布局，翻棋决定阵营。

### 命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `/军棋` | `junqi`, `翻棋` | 发起军棋对局 |
| `/加入军棋` | `joinjunqi` | 加入对局 |
| `/翻 <坐标>` | `flip`, `f` | 翻开棋子，如 `/翻 A1` |
| `/军 <起点>-<终点>` | `jmove`, `jm` | 移动或吃子，如 `/军 A1-A2` |
| `/棋盘` | `board`, `查看棋盘` | 查看当前棋盘 |
| `/认输` | `surrender`, `投降` | 认输 |
| `/结束游戏` | `endgame`, `结束军棋` | 强制结束 |

### 坐标系统

```
   A  B  C  D  E  F
10 □  □  □  □  □  □
 9 □  □  □  □  □  □
 8 □  □  □  □  □  □
 7 □  □  □  □  □  □
 6 □  □  □  □  □  □
 5 □  □  □  □  □  □
 4 □  □  □  □  □  □
 3 □  □  □  □  □  □
 2 □  □  □  □  □  □
 1 □  □  □  □  □  □
```

### 游戏流程

```
玩家A: /军棋         ← 发起游戏
玩家B: /加入军棋     ← 加入游戏
玩家A: /翻 C5        ← 翻开 C5 位置的棋子（决定阵营）
玩家B: /翻 D6        ← 翻开 D6 位置的棋子
玩家A: /军 C5-C6     ← 移动 C5 的棋子到 C6
...                   ← 交替翻棋/移动直到吃掉对方军旗
```

### 棋子

每方 25 个棋子：
- 司令 ×1（最大）
- 军长 ×1
- 师长 ×2
- 旅长 ×2
- 团长 ×2
- 营长 ×2
- 连长 ×3
- 排长 ×3
- 工兵 ×3（最小，可挖地雷）
- 炸弹 ×2（同归于尽）
- 地雷 ×3（不能移动）
- 军旗 ×1（不能移动，被吃则输）

### 规则

- 开局所有棋子背面朝上，随机分布
- 第一个翻开的棋子决定玩家阵营（红或蓝）
- 玩家每回合可以：翻开一个棋子 或 移动一个己方已翻开的棋子
- 大吃小：等级高的棋子可以吃等级低的
- 工兵可以挖地雷（其他棋子碰地雷同归于尽）
- 炸弹与任何棋子同归于尽
- 军旗和地雷不能移动
- 吃掉对方军旗即获胜

---

## 配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `render_service_url` | string | `http://172.17.0.1:51234` | text2img-service 图片渲染服务地址 |
| `turn_timeout_seconds` | int | `60` | 每回合思考时间（秒），超时自动认输，设为 0 禁用 |
| `join_timeout_seconds` | int | `60` | 等待对手加入超时（秒），超时自动取消游戏，设为 0 禁用 |

## 依赖

- **aiohttp**: HTTP 客户端
- **apscheduler**: 定时任务（超时功能）
- **text2img-service**: 图片渲染服务

### 部署 text2img-service

```bash
cd text2img-service
docker compose up -d --build
```

确保服务正常运行后，插件会自动调用渲染 API 生成精美的游戏图片。

如果渲染服务不可用，插件会自动回退到纯文本模式。

---

## 文件结构

```
astrbot_plugin_game/
├── main.py               # 插件入口，命令注册
├── metadata.yaml         # 插件元数据
├── _conf_schema.json     # 配置定义
├── requirements.txt      # Python 依赖
├── README.md
├── games/
│   ├── __init__.py
│   ├── tictactoe.py      # 井字棋游戏逻辑
│   ├── go.py             # 围棋游戏逻辑
│   ├── xiangqi.py        # 象棋游戏逻辑
│   ├── gomoku.py         # 五子棋游戏逻辑
│   └── junqi.py          # 军棋游戏逻辑
└── services/
    ├── __init__.py
    └── image_renderer.py # 图片渲染客户端
```

## text2img-service 模板

游戏使用以下自定义模板：

| 模板文件 | API 端点 | 说明 |
|----------|----------|------|
| `templates/tictactoe.ejs` | `POST /api/tictactoe` | 井字棋渲染 |
| `templates/go.ejs` | `POST /api/go` | 围棋渲染 |
| `templates/xiangqi.ejs` | `POST /api/xiangqi` | 象棋渲染 |
| `templates/gomoku.ejs` | `POST /api/gomoku` | 五子棋渲染 |
| `templates/junqi.ejs` | `POST /api/junqi` | 军棋渲染 |
| `templates/gamehelp.ejs` | `POST /api/gamehelp` | 帮助页面渲染 |

模板已包含在 text2img-service 中，部署后即可使用。
